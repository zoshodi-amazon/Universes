# ===============================================================================
# UNIVERSES PRELUDE - Dendritic Nix Configuration System
# ===============================================================================
#
# NAME
#     justfile - Capability-centric module and machine management
#
# SYNOPSIS
#     just <recipe> [arguments...]
#     just --list
#
# DESCRIPTION
#     Thin interface to scripts in Modules/Labs/Scripts/.
#     Organized by capability, not implementation.
#
#     INTROSPECT  - Discover modules, features, and options
#     CREATE      - Scaffold new modules and features
#     BUILD       - Compile and validate
#     DEPLOY      - Flash and connect to machines
#     SYNC        - Remote build operations
#
# PHILOSOPHY
#     Index on CAPABILITY, not IMPLEMENTATION.
#     Options define types (what), Bindings define terms (how).
#     See AGENTS.md for full ontology.
#
# SCRIPTS
#     All scripts live in Modules/Labs/Scripts/Universe/*/Bindings/Scripts/
#
# ===============================================================================

scripts := "Modules/Labs/Scripts/Universe"

default:
    @just --list

# -------------------------------------------------------------------------------
# INTROSPECT
# -------------------------------------------------------------------------------

# List all modules by category (Labs, User, Host, Fleet)
modules:
    @gum style --border normal --padding "0 1" "Modules"
    @nu {{scripts}}/Discover/Bindings/Scripts/default.nu

# List Universe features in a module
# ARGS: module - path to module (e.g., Modules/User/Terminal/Shell)
features module:
    @gum style --border normal --padding "0 1" "Features in $(gum style --foreground 212 '{{module}}')"
    @nu {{scripts}}/Introspect/Bindings/Scripts/default.nu '{"mode": "features", "module": "{{module}}"}'

# Show Options type space for all features in a module
# ARGS: module - path to module (e.g., Modules/User/Terminal/Shell)
options module:
    @gum style --border normal --padding "0 1" "Options in $(gum style --foreground 212 '{{module}}')"
    @nu {{scripts}}/Introspect/Bindings/Scripts/default.nu '{"mode": "options", "module": "{{module}}"}'

# Show machine options schema (capability space for machine definitions)
schema:
    @gum style --border normal --padding "0 1" "Machine Schema"
    @echo "machines.<name> = {"
    @echo "  identity.hostname    : str           # What is this machine called?"
    @echo "  target.arch          : enum          # x86_64 | aarch64"
    @echo "  format.type          : enum          # iso | vm | sd-image | raw-efi | oci"
    @echo "  persistence.strategy : enum          # full | impermanent | ephemeral"
    @echo "  persistence.device   : str?          # e.g., /dev/disk/by-label/NIXOS_PERSIST"
    @echo "  persistence.paths    : [str]         # Directories to persist"
    @echo "  users                : [user]        # Users on this machine"
    @echo "};"

# List all defined machines (queries flake.nixosConfigurations)
list:
    @gum style --border normal --padding "0 1" "Machines"
    @nix eval .#nixosConfigurations --apply 'x: builtins.attrNames x' 2>/dev/null || echo "(eval error - run on Linux)"

# -------------------------------------------------------------------------------
# CREATE
# -------------------------------------------------------------------------------

# Scaffold a new module from frozen template (Docs/TEMPLATE.md)
# ARGS: path - module path (e.g., Modules/User/Foo)
new-module path:
    @gum style --border normal --padding "0 1" "Creating module $(gum style --foreground 212 '{{path}}')"
    @nu {{scripts}}/Scaffold/Bindings/Scripts/default.nu '{"mode": "module", "path": "{{path}}"}'
    @gum style --foreground 82 "Module created"

# Add a feature to a module (creates Universe/<name> with Options/Bindings)
# ARGS: module - path to module, name - feature name (e.g., Core, Config)
new-feature module name:
    @gum style --border normal --padding "0 1" "Creating feature $(gum style --foreground 212 '{{name}}') in $(gum style --foreground 212 '{{module}}')"
    @nu {{scripts}}/Scaffold/Bindings/Scripts/default.nu '{"mode": "feature", "path": "{{module}}", "name": "{{name}}"}'
    @gum style --foreground 82 "Feature created"

# -------------------------------------------------------------------------------
# BUILD
# -------------------------------------------------------------------------------

# Build a machine image based on its format.type option
# ARGS: machine - name of machine (e.g., sovereignty)
# NOTE: Must run on Linux to build NixOS images
build machine:
    @gum style --border normal --padding "0 1" "Building $(gum style --foreground 212 '{{machine}}')"
    @gum spin --spinner dot --title "Building ISO..." -- nix build .#{{machine}}-iso --print-out-paths
    @gum style --foreground 82 "Build complete"

# Run machine in QEMU VM for testing before flashing
# ARGS: machine - name of machine (e.g., sovereignty)
vm machine:
    @gum style --foreground 212 "Starting VM: {{machine}}"
    @nix run .#{{machine}}-vm

# Validate all modules (runs nix flake check)
check:
    @gum style --border normal --padding "0 1" "Checking flake"
    @gum spin --spinner dot --title "Validating..." -- nix flake check
    @gum style --foreground 82 "Check passed"

# -------------------------------------------------------------------------------
# DEPLOY
# -------------------------------------------------------------------------------

# Flash ISO to USB drive (uses ~/Downloads/<machine>.iso if exists, else builds)
# ARGS: machine - name of machine, disk - target disk (e.g., /dev/disk4)
# WARNING: Erases all data on target disk
flash machine disk:
    @gum style --border normal --foreground 196 --padding "0 1" "WARNING: This will erase {{disk}}"
    @gum confirm "Flash {{machine}} to {{disk}}?" && nu {{scripts}}/Deploy/Bindings/Scripts/default.nu '{"mode": "flash", "machine": "{{machine}}", "disk": "{{disk}}"}'

# Unmount all volumes on a disk (required before flashing)
# ARGS: disk - target disk (e.g., /dev/disk4)
unmount disk:
    @gum style --foreground 212 "Unmounting {{disk}}"
    @diskutil unmountDisk {{disk}} 2>/dev/null || echo "Already unmounted"

# Format SD card for persistence (ext4 with label NIXOS_PERSIST)
# ARGS: disk - target disk (e.g., /dev/sdb)
# WARNING: Erases all data on target disk
format-persist disk:
    @gum style --border normal --foreground 196 --padding "0 1" "WARNING: This will erase {{disk}}"
    @gum confirm "Format {{disk}} for persistence?" && nu {{scripts}}/Deploy/Bindings/Scripts/default.nu '{"mode": "format-persist", "disk": "{{disk}}"}'

# SSH into a deployed machine
# ARGS: machine - hostname, user - SSH user (optional)
ssh machine user="":
    @gum style --foreground 212 "Connecting to {{machine}}"
    @if [ -z "{{user}}" ]; then ssh {{machine}}; else ssh {{user}}@{{machine}}; fi

# -------------------------------------------------------------------------------
# SYNC
# -------------------------------------------------------------------------------

# Sync repo to remote host (for building on Linux from macOS)
# ARGS: host - SSH host (e.g., cloud-dev)
sync-to host:
    @gum style --border normal --padding "0 1" "Syncing to $(gum style --foreground 212 '{{host}}')"
    @gum spin --spinner dot --title "Syncing..." -- rsync -avz --delete ~/repos/Universes/ {{host}}:~/repos/Universes/
    @gum style --foreground 82 "Sync complete"

# Build on remote host and copy ISO back to ~/Downloads/<machine>.iso
# ARGS: host - SSH host, machine - name of machine
remote-build host machine:
    @gum style --border normal --padding "0 1" "Remote build $(gum style --foreground 212 '{{machine}}') on $(gum style --foreground 212 '{{host}}')"
    @nu {{scripts}}/Deploy/Bindings/Scripts/default.nu '{"mode": "remote-build", "host": "{{host}}", "machine": "{{machine}}"}'

# Build OCI image on remote host and copy back to ~/Downloads/<machine>.tar.gz
# ARGS: host - SSH host, machine - name of machine
remote-build-oci host machine:
    @gum style --border normal --padding "0 1" "Remote build OCI $(gum style --foreground 212 '{{machine}}') on $(gum style --foreground 212 '{{host}}')"
    @nu {{scripts}}/Deploy/Bindings/Scripts/default.nu '{"mode": "remote-build-oci", "host": "{{host}}", "machine": "{{machine}}"}'

# Build VM on remote host and run locally via QEMU
# ARGS: host - SSH host, machine - name of machine
remote-build-vm host machine:
    @gum style --border normal --padding "0 1" "Remote build VM $(gum style --foreground 212 '{{machine}}') on $(gum style --foreground 212 '{{host}}')"
    @nu {{scripts}}/Deploy/Bindings/Scripts/default.nu '{"mode": "remote-build-vm", "host": "{{host}}", "machine": "{{machine}}"}'

# Load OCI image into local podman
# ARGS: machine - name of machine (expects ~/Downloads/<machine>.tar.gz)
load-oci machine:
    @gum style --border normal --padding "0 1" "Loading OCI $(gum style --foreground 212 '{{machine}}')"
    @podman machine start 2>/dev/null || true
    @podman load < ~/Downloads/{{machine}}.tar.gz
    @gum style --foreground 82 "Loaded {{machine}}:latest"

# Run OCI image in podman (privileged for NixOS system containers)
# ARGS: machine - name of machine
run-oci machine:
    @gum style --foreground 212 "Running {{machine}}"
    @podman machine start 2>/dev/null || true
    @podman run -it --privileged {{machine}}:latest

# Run VM locally via QEMU (expects ~/VMs/<machine> from remote-build-vm)
# ARGS: machine - name of machine
run-vm machine:
    @gum style --foreground 212 "Running VM {{machine}}"
    @~/VMs/{{machine}}/bin/run-*-vm

# Run VM on remote host via SSH (with X11 forwarding)
# ARGS: host - SSH host, machine - name of machine
run-vm-remote host machine:
    @gum style --foreground 212 "Running VM {{machine}} on {{host}}"
    @ssh -Y {{host}} "source ~/.nix-profile/etc/profile.d/nix.sh && cd ~/repos/Universes/Prelude && nix run .#{{machine}}-vm"

# Build and run MicroVM on remote host (stays running in foreground)
# ARGS: host - SSH host, machine - name of machine (must have format.type = "microvm")
remote-microvm host machine:
    @gum style --border normal --padding "0 1" "MicroVM $(gum style --foreground 212 '{{machine}}') on $(gum style --foreground 212 '{{host}}')"
    @just sync-to {{host}}
    @ssh -t {{host}} "source ~/.nix-profile/etc/profile.d/nix.sh && cd ~/repos/Universes/Prelude && nix run .#{{machine}}-microvm"

# SSH into running MicroVM on remote host (via port forward 2222)
# ARGS: host - SSH host where microvm is running, user - guest user (default: root)
ssh-microvm host user="root":
    @gum style --foreground 212 "SSH to MicroVM via {{host}}:2222"
    @ssh -J {{host}} -p 2222 {{user}}@localhost

# Initialize podman machine (Darwin only, run once)
podman-init:
    @gum style --border normal --padding "0 1" "Initializing podman machine"
    @podman machine init
    @podman machine start
    @gum style --foreground 82 "Podman machine ready"

# -------------------------------------------------------------------------------
# HOME
# -------------------------------------------------------------------------------

# Switch to home configuration
# ARGS: host - home configuration name (default: darwin)
switch host="darwin":
    #!/usr/bin/env nu
    gum style --border normal --padding "0 1" $"Switching to (gum style --foreground 212 '{{host}}')"
    let result = (do { home-manager switch --flake $".#{{host}}" } | complete)
    if $result.exit_code == 0 {
        gum style --foreground 82 "Switch complete"
    } else {
        let output = [$result.stdout $result.stderr] | str join "\n" | str trim
        if ($output | is-not-empty) {
            print (gum style --border double --border-foreground 196 --foreground 196 --padding "1 2" $output)
        }
        exit 1
    }

# -------------------------------------------------------------------------------
# PRESETS
# -------------------------------------------------------------------------------

preset_scripts := "Modules/Labs/Scripts/Universe/Preset"

# List available tmux presets
presets:
    @nu {{preset_scripts}}/Bindings/Scripts/default.nu list

# Launch tmux preset session
# ARGS: name - preset name (explore, compare, monitor, develop), domain - lab domain (Audio, Video, etc.)
preset name domain="Audio":
    @nu {{preset_scripts}}/Bindings/Scripts/default.nu '{"preset": "{{name}}", "workdir": "Modules/Labs/{{domain}}"}'

# -------------------------------------------------------------------------------
# LABS
# -------------------------------------------------------------------------------

# Launch Lab in domain-specific preset (rl for RL, explore for others)
# ARGS: domain - lab domain (Audio, RL, Game, etc.)
lab domain="Audio":
    #!/usr/bin/env nu
    let preset: string = match "{{domain}}" {
      "RL" => "rl"
      _ => "explore"
    }
    nu Modules/Labs/Scripts/Universe/Preset/Bindings/Scripts/default.nu $'{"preset": "($preset)", "workdir": "Modules/Labs/{{domain}}"}'
