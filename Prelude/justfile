# Universes Prelude - Machine Management
# Usage: just <recipe> [args]
# Run `just --list` for all available commands

# Default recipe - show help
default:
    @just --list

# ─────────────────────────────────────────────────────────────────────────────
# MACHINE MANAGEMENT
# ─────────────────────────────────────────────────────────────────────────────

# List all defined machines
# Usage: just list
list:
    @echo "Defined machines:"
    @nix eval .#nixosConfigurations --apply 'x: builtins.attrNames x' 2>/dev/null || echo "  (none or eval error)"

# Build a machine image
# Usage: just build <machine>
# Example: just build sovereignty
# Output: ./result/ contains the built image
build machine:
    nix build .#{{machine}}-iso --print-out-paths

# Build and run machine in QEMU VM (for testing)
# Usage: just vm <machine>
# Example: just vm sovereignty
# Note: Requires x86_64-linux or aarch64-linux host
vm machine:
    nix run .#{{machine}}-vm

# ─────────────────────────────────────────────────────────────────────────────
# DEPLOYMENT
# ─────────────────────────────────────────────────────────────────────────────

# Flash ISO to USB drive
# Usage: just flash <machine> <disk>
# Example: just flash sovereignty /dev/disk4
# WARNING: This will ERASE ALL DATA on the target disk
# Args:
#   machine - Name of the machine config (e.g., sovereignty)
#   disk    - Target disk device (e.g., /dev/sda, /dev/disk4)
flash machine disk:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Building {{machine}} ISO..."
    nix build .#{{machine}}-iso --print-out-paths
    ISO=$(find result/iso -name "*.iso" | head -1)
    echo ""
    echo "WARNING: This will ERASE ALL DATA on {{disk}}"
    echo "ISO: $ISO"
    echo ""
    read -p "Type 'yes' to confirm: " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Aborted."
        exit 1
    fi
    echo "Flashing to {{disk}}..."
    sudo dd if="$ISO" of={{disk}} bs=4M status=progress conv=fsync
    sync
    echo "Done! USB is ready to boot."

# Format SD card for persistence
# Usage: just format-persist <disk>
# Example: just format-persist /dev/sdb
# Creates ext4 filesystem with label NIXOS_PERSIST
# WARNING: This will ERASE ALL DATA on the target disk
# Args:
#   disk - Target disk device for persistence (e.g., /dev/sdb)
format-persist disk:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "WARNING: This will ERASE ALL DATA on {{disk}}"
    echo "Creating persistence partition with label NIXOS_PERSIST"
    echo ""
    read -p "Type 'yes' to confirm: " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Aborted."
        exit 1
    fi
    sudo mkfs.ext4 -L NIXOS_PERSIST {{disk}}
    echo "Done! SD card is ready for persistence."

# ─────────────────────────────────────────────────────────────────────────────
# REMOTE MANAGEMENT
# ─────────────────────────────────────────────────────────────────────────────

# SSH into a deployed machine
# Usage: just ssh <machine> [user]
# Example: just ssh sovereignty
# Example: just ssh sovereignty root
# Args:
#   machine - Hostname of the machine
#   user    - SSH user (default: nixos)
ssh machine user="nixos":
    ssh {{user}}@{{machine}}

# ─────────────────────────────────────────────────────────────────────────────
# DEVELOPMENT
# ─────────────────────────────────────────────────────────────────────────────

# Check flake for errors
check:
    nix flake check

# Show machine options schema
# Usage: just schema
schema:
    @echo "Machine options schema:"
    @echo ""
    @echo "machines.<name> = {"
    @echo "  identity.hostname = <str>;      # What is this machine called?"
    @echo "  target.arch = x86_64|aarch64;   # What architecture?"
    @echo "  format.type = iso|vm|sd-image;  # How do I deploy it?"
    @echo "  persistence.strategy = full|impermanent|ephemeral;"
    @echo "  persistence.device = <str?>;    # Where is persistent storage?"
    @echo "  persistence.paths = [<str>];    # What paths to persist?"
    @echo "};"
