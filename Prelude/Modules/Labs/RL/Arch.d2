# RL Module Architecture
# Capability-centric RL pipeline with SQLite + OTEL observability

direction: right

# =============================================================================
# OPTIONS (Abstract Capability Schema)
# =============================================================================

Options: {
  label: "Options (Abstract)"
  style.fill: "#e1f5fe"
  
  Env: {
    envId: "CartPole-v1"
    nEnvs: 8
    seed: 42
  }
  
  Obs: {
    normalize: true
    clipRange: 10.0
    stackFrames: null
  }
  
  Agent: {
    algorithm: "ppo"
    policyType: "MlpPolicy"
    netArch: "[64, 64]"
  }
  
  Train: {
    totalTimesteps: 100000
    learningRate: "3e-4"
    batchSize: 64
    gamma: 0.99
  }
  
  Eval: {
    episodes: 10
    deterministic: true
  }
  
  Store: {
    backend: "local | mlflow | wandb"
    trackingUri: "generic endpoint"
    experimentName: "generic name"
    modelDir: "./models"
  }
  
  Registry: {
    label: "Registry (SQLite)"
    enable: true
    dbPath: "./rl_registry.db"
    minReward: 195.0
    keepTopN: 10
  }
  
  Metrics: {
    label: "Metrics (OTEL)"
    enable: true
    endpoint: "http://localhost:4318"
    trackReward: true
    trackLoss: true
  }
  
  Traces: {
    label: "Traces (OTEL)"
    enable: true
    endpoint: "http://localhost:4318"
    traceEpisodes: true
    traceSteps: false
  }
  
  Logs: {
    label: "Logs (OTEL)"
    enable: true
    endpoint: "http://localhost:4318"
    level: "info"
  }
}

# =============================================================================
# BINDINGS (Vendor-Specific ENV Mapping)
# =============================================================================

Bindings: {
  label: "Bindings (Concrete)"
  style.fill: "#fff3e0"
  
  CoreEnv: {
    label: "Core ENV"
    vars: |md
      RL_ENV_ID
      RL_AGENT_ALGORITHM
      RL_TRAIN_TIMESTEPS
      RL_TRAIN_LEARNING_RATE
    |
  }
  
  StoreEnv: {
    label: "Store ENV"
    mlflow: "MLFLOW_TRACKING_URI"
    wandb: "WANDB_BASE_URL"
    local: "RL_STORE_MODEL_DIR"
  }
  
  RegistryEnv: {
    label: "Registry ENV"
    vars: |md
      RL_REGISTRY_DB=./rl_registry.db
      RL_REGISTRY_MIN_REWARD=195.0
      RL_REGISTRY_KEEP_TOP_N=10
    |
  }
  
  MetricsEnv: {
    label: "Metrics ENV"
    vars: |md
      OTEL_METRICS_EXPORTER=otlp
      OTEL_EXPORTER_OTLP_ENDPOINT
      RL_METRICS_TRACK_REWARD=1
      RL_METRICS_TRACK_LOSS=1
    |
  }
  
  TracesEnv: {
    label: "Traces ENV"
    vars: |md
      OTEL_TRACES_EXPORTER=otlp
      OTEL_EXPORTER_OTLP_ENDPOINT
      RL_TRACES_SAMPLE_RATE=1.0
    |
  }
  
  LogsEnv: {
    label: "Logs ENV"
    vars: |md
      OTEL_LOGS_EXPORTER=otlp
      OTEL_EXPORTER_OTLP_ENDPOINT
      RL_LOGS_LEVEL=info
    |
  }
}

# =============================================================================
# INSTANCES (Nix Targets)
# =============================================================================

Instances: {
  label: "Instances (Nix Targets)"
  style.fill: "#e8f5e9"
  
  devShell: {
    label: "devShells.rl"
    packages: |md
      sb3 (custom)
      gymnasium
      sqlite
      opentelemetry-api
      opentelemetry-sdk
      opentelemetry-exporter-otlp
    |
  }
  
  cmds: {
    label: "Commands"
    "rl-train": "Train agent"
    "rl-eval": "Evaluate model"
    "rl-infer": "Run inference"
    "rl-registry-list": "List models"
    "rl-registry-validate": "Validate model"
  }
}

# =============================================================================
# RUNTIME STACK
# =============================================================================

Runtime: {
  label: "Runtime Stack"
  style.fill: "#fce4ec"
  
  SQLite: {
    label: "SQLite (default)"
    style.fill: "#c8e6c9"
    schema: |md
      models table:
      - id, model_path, algorithm
      - timestamp, total_timesteps
      - mean_reward, std_reward
      - hyperparams (JSON)
      - validated (bool)
    |
  }
  
  OTEL: {
    label: "OTEL (optional)"
    style.fill: "#b3e5fc"
    
    Collector: {
      label: "otel-collector"
      receivers: "otlp (grpc/http)"
      exporters: "prometheus, jaeger, loki"
    }
    
    Prometheus: {
      label: "Prometheus"
      metrics: "reward, loss, entropy, fps"
    }
    
    Jaeger: {
      label: "Jaeger"
      traces: "episodes, steps, evals"
    }
    
    Loki: {
      label: "Loki"
      logs: "checkpoints, errors"
    }
  }
  
  MLflow: {
    label: "MLflow (optional)"
    style.fill: "#ffe0b2"
    backend: "sqlite:///mlflow.db"
    artifacts: "./mlruns/"
  }
}

# =============================================================================
# PIPELINE
# =============================================================================

Pipeline: {
  label: "RL Pipeline"
  style.fill: "#f3e5f5"
  
  Env: {
    label: "Env"
    impl: "gymnasium.make()"
  }
  
  Agent: {
    label: "Agent"
    impl: "sb3.PPO()"
  }
  
  Train: {
    label: "Train"
    impl: "model.learn()"
    emits: "metrics, traces, logs"
  }
  
  Eval: {
    label: "Eval"
    impl: "evaluate_policy()"
    writes: "registry"
  }
  
  Infer: {
    label: "Infer"
    impl: "model.predict()"
    loads: "registry (best)"
  }
  
  Env -> Agent -> Train -> Eval -> Infer
}

# =============================================================================
# OBSERVABILITY FLOW
# =============================================================================

ObsFlow: {
  label: "Observability Flow"
  style.fill: "#e1bee7"
  
  TrainingLoop: {
    label: "Training Loop"
    style.fill: "#f3e5f5"
  }
  
  SignalLayer: {
    label: "Signal (Continuous)"
    style.fill: "#b3e5fc"
    
    MetricsStream: "reward, loss per step"
    TracesStream: "episode spans"
    LogsStream: "checkpoint events"
  }
  
  InfoLayer: {
    label: "Labs (perSystem)"
    style.fill: "#c8e6c9"
    
    RegistryDB: "model metadata"
    StoreArtifacts: "experiment artifacts"
  }
  
  TrainingLoop -> SignalLayer.MetricsStream: "emit"
  TrainingLoop -> SignalLayer.TracesStream: "emit"
  TrainingLoop -> SignalLayer.LogsStream: "emit"
  TrainingLoop -> InfoLayer.RegistryDB: "write"
  TrainingLoop -> InfoLayer.StoreArtifacts: "save"
}

# =============================================================================
# VALIDATION & HOTSWAP
# =============================================================================

Validation: {
  label: "Validation & Hotswap"
  style.fill: "#fff9c4"
  
  CheckpointSaved: {
    label: "1. Checkpoint Saved"
    action: "Write to Registry (validated=0)"
  }
  
  EvalRuns: {
    label: "2. Eval Runs"
    action: "Compute mean_reward, std_reward"
  }
  
  ValidationLayer: {
    label: "3. Validation Layer"
    checks: |md
      - mean_reward >= minReward
      - total_timesteps >= threshold
      - std_reward < mean_reward * 0.5
    |
  }
  
  MarkValidated: {
    label: "4. Mark Validated"
    action: "UPDATE models SET validated=1"
  }
  
  Hotswap: {
    label: "5. Hotswap"
    query: |md
      SELECT model_path FROM models
      WHERE validated=1
      ORDER BY mean_reward DESC
      LIMIT 1
    |
  }
  
  CheckpointSaved -> EvalRuns -> ValidationLayer -> MarkValidated -> Hotswap
}

# =============================================================================
# CONNECTIONS
# =============================================================================

Options.Env -> Bindings.CoreEnv
Options.Agent -> Bindings.CoreEnv
Options.Train -> Bindings.CoreEnv
Options.Store -> Bindings.StoreEnv
Options.Registry -> Bindings.RegistryEnv
Options.Metrics -> Bindings.MetricsEnv
Options.Traces -> Bindings.TracesEnv
Options.Logs -> Bindings.LogsEnv

Bindings.CoreEnv -> Instances.devShell
Bindings.StoreEnv -> Instances.devShell
Bindings.RegistryEnv -> Instances.devShell
Bindings.MetricsEnv -> Instances.devShell
Bindings.TracesEnv -> Instances.devShell
Bindings.LogsEnv -> Instances.devShell

Instances.cmds -> Pipeline.Train
Instances.cmds -> Pipeline.Eval
Instances.cmds -> Pipeline.Infer

Pipeline.Train -> Runtime.SQLite: "write metadata"
Pipeline.Train -> Runtime.OTEL.Collector: "emit telemetry"
Pipeline.Train -> Runtime.MLflow: "log artifacts"

Runtime.OTEL.Collector -> Runtime.OTEL.Prometheus: "metrics"
Runtime.OTEL.Collector -> Runtime.OTEL.Jaeger: "traces"
Runtime.OTEL.Collector -> Runtime.OTEL.Loki: "logs"

Pipeline.Eval -> Runtime.SQLite: "write eval results"
Pipeline.Infer -> Runtime.SQLite: "query best model"

# =============================================================================
# CATEGORICAL ALIGNMENT
# =============================================================================

Categories: {
  label: "Categorical Alignment"
  style.fill: "#f5f5f5"
  
  Labs: {
    label: "Labs (perSystem)"
    style.fill: "#e3f2fd"
    items: "Env, Obs, Agent, Train, Eval, Infer"
  }
  
  Labs: {
    label: "Labs (perSystem)"
    style.fill: "#e8f5e9"
    items: "Registry (SQLite), Store (MLflow), Trained Models"
  }
  
  Signal: {
    label: "Signal (Continuous)"
    style.fill: "#fff3e0"
    items: "Metrics (OTEL), Traces (OTEL), Logs (OTEL)"
  }
}

# =============================================================================
# DEFAULTS
# =============================================================================

Defaults: {
  label: "Zero Config Defaults"
  style.fill: "#c8e6c9"
  style.stroke: "#2e7d32"
  
  registry: "./rl_registry.db"
  models: "./models/"
  logs: "./logs/"
  otel: "disabled (opt-in)"
  store: "local"
}
