# RL Module Architecture
# Morphism diagram: Options (types) -> Bindings (terms) -> Effects (runtime)
# Stack: Nix (types) -> Nushell (glue) -> CLIs (effects)

direction: right

# =============================================================================
# OPTIONS (Types)
# =============================================================================

Options: {
  label: "Options (Types)"
  style.fill: "#e1f5fe"

  Data: {
    label: "Data : DataSpec"
    shape: class
    provider: "enum [csv yahoo alpaca ccxt]"
    tickers: "list str = [AAPL]"
    interval: "enum [1m 5m 15m 1h 1d]"
    startDate: "str = 2020-01-01"
    endDate: "str = 2023-12-31"
    indicators: "list str = [macd rsi_30]"
    dataDir: "str = .lab/data"
  }

  Env: {
    label: "Env : EnvSpec"
    shape: class
    envId: "str = stocks-v0"
    nEnvs: "int = 4"
    seed: "int? = null"
  }

  Observation: {
    label: "Observation : ObsSpec"
    shape: class
    normalize: "enum [none running fixed]"
    clipRange: "str = 10.0"
    stackFrames: "int? = null"
  }

  Agent: {
    label: "Agent : AgentSpec"
    shape: class
    algorithm: "enum [ppo a2c dqn sac td3]"
    policyType: "enum [MlpPolicy CnnPolicy]"
    netArch: "list int = [64 64]"
  }

  Train: {
    label: "Train : TrainSpec"
    shape: class
    totalTimesteps: "int = 100000"
    learningRate: "str = 3e-4"
    batchSize: "int = 64"
    gamma: "str = 0.99"
  }

  Eval: {
    label: "Eval : EvalSpec"
    shape: class
    episodes: "int = 10"
    deterministic: "bool = true"
  }

  Infer: {
    label: "Infer : InferSpec"
    shape: class
    device: "enum [auto cpu cuda mps]"
  }

  Execution: {
    label: "Execution : ExecSpec"
    shape: class
    provider: "enum [backtest paper live]"
    maxPosition: "str = 100"
  }

  Store: {
    label: "Store : StoreSpec"
    shape: class
    backend: "enum [local mlflow wandb]"
    modelDir: "str = ./models"
    checkpointFreq: "int = 10000"
  }

  Registry: {
    label: "Registry : RegistrySpec"
    shape: class
    dbPath: "str = ./rl.db"
    minReward: "str = 0"
    keepTopN: "int = 10"
  }

  Metrics: {
    label: "Metrics : OTEL"
    shape: class
    enable: "bool = false"
    trackReward: "bool = true"
  }

  Traces: {
    label: "Traces : OTEL"
    shape: class
    enable: "bool = false"
    traceEpisodes: "bool = true"
  }

  Logs: {
    label: "Logs : OTEL"
    shape: class
    enable: "bool = false"
    level: "enum [debug info warn error]"
  }

  Telemetry: {
    label: "Telemetry : LookingGlass"
    shape: class
    dbPath: "str = ./rl.db"
    logDir: "str = ./logs"
  }
}

# =============================================================================
# BINDINGS (Terms)
# =============================================================================

Bindings: {
  label: "Bindings (Terms)"
  style.fill: "#fff3e0"

  data_nu: {
    label: "Data/Scripts/default.nu"
    shape: page
    signature: "DataSpec -> OHLCV"
  }

  train_nu: {
    label: "Train/Scripts/default.nu"
    shape: page
    signature: "TrainSpec -> Effect"
  }

  eval_nu: {
    label: "Eval/Scripts/default.nu"
    shape: page
    signature: "EvalSpec -> Effect"
  }

  infer_nu: {
    label: "Infer/Scripts/default.nu"
    shape: page
    signature: "InferSpec -> Effect"
  }

  registry_nu: {
    label: "Registry/Scripts/default.nu"
    shape: page
    signature: "RegistrySpec -> Table"
  }

  exec_nix: {
    label: "Execution/Bindings/default.nix"
    shape: page
    signature: "ExecSpec -> ENV"
  }

  store_nix: {
    label: "Store/Bindings/default.nix"
    shape: page
    signature: "StoreSpec -> ENV"
  }

  data_nix: {
    label: "Data/Bindings/default.nix"
    shape: page
    signature: "DataSpec -> ENV"
  }

  secrets: {
    label: "Execution/Secrets"
    shape: page
    signature: "Provider -> Credentials"
  }
}

# =============================================================================
# DERIVATIONS (Frozen CLIs)
# =============================================================================

Drv: {
  label: "Drv/ (Frozen CLIs)"
  style.fill: "#f3e5f5"

  rl: {
    label: "rl (Python CLI)"
    shape: package
    subcommands: |md
      rl data preview  -- dataset summary
      rl data download -- fetch from provider
      rl train         -- sb3 learn + checkpoints
      rl eval          -- sb3 evaluate_policy
      rl infer         -- sb3 predict
      rl registry      -- SQLite CRUD
    |
  }
}

# =============================================================================
# DATA (Effects)
# =============================================================================

Data_layer: {
  label: "Data (Effects)"
  style.fill: "#e8f5e9"

  csv: {
    label: "CSV (.lab/data/)"
    shape: cylinder
  }

  sqlite: {
    label: "SQLite (rl.db)"
    shape: cylinder
  }

  logs: {
    label: "Logs (./logs/)"
    shape: document
  }

  models: {
    label: "Models (./models/)"
    shape: document
  }
}

# =============================================================================
# TMUX PRESET
# =============================================================================

IDE: {
  label: "just lab (tmux rl-lab)"
  style.fill: "#fce4ec"

  layout: |md
    +---------------------------+---------------------------+
    | 1. Shell                  | 2. Train (just train)     |
    +---------------------------+---------------------------+
    | 3. Registry (just watch)  | 4. Data (just data)       |
    +---------------------------+---------------------------+
    | 5. Logs (just logs)       | 6. Status (just status)   |
    +---------------------------+---------------------------+
  |
}

# =============================================================================
# MORPHISMS
# =============================================================================

# Data flow
Options.Data -> Bindings.data_nix: "ENV vars"
Options.Data -> Bindings.data_nu: "config"
Bindings.data_nu -> Drv.rl: "^rl data"
Drv.rl -> Data_layer.csv: "read/write OHLCV"

# Execution flow
Options.Execution -> Bindings.exec_nix: "ENV vars"
Options.Execution -> Bindings.secrets: "credential refs"

# Compute flow
Options.Env -> Bindings.train_nu: "config"
Options.Agent -> Bindings.train_nu: "config"
Options.Train -> Bindings.train_nu: "config"
Bindings.train_nu -> Drv.rl: "^rl train"

Options.Eval -> Bindings.eval_nu: "config"
Bindings.eval_nu -> Drv.rl: "^rl eval"

Options.Infer -> Bindings.infer_nu: "config"
Bindings.infer_nu -> Drv.rl: "^rl infer"

# Information flow
Options.Store -> Bindings.store_nix: "config"
Options.Registry -> Bindings.registry_nu: "config"
Bindings.registry_nu -> Drv.rl: "^rl registry"

# Effects
Drv.rl -> Data_layer.sqlite: "write runs"
Drv.rl -> Data_layer.logs: "stdout/stderr"
Drv.rl -> Data_layer.models: "checkpoints"

# IDE
IDE -> Data_layer.csv: "data pane"
IDE -> Data_layer.sqlite: "registry pane"
IDE -> Data_layer.logs: "logs pane"
